<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineCraze - Enhanced Streaming Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    <style>
        :root {
            --primary: #e50914;
            --primary-dark: #b20710;
            --dark: #141414;
            --dark-2: #1a1a1a;
            --dark-3: #222222;
            --light: #f5f5f5;
            --light-2: #e6e6e6;
            --gray: #8c8c8c;
            --transition: all 0.3s ease;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            --radius: 8px;
            --header-height: 70px;
            --footer-height: 120px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark);
            color: var(--light);
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }

        /* Header Styles */
        header {
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            padding: 15px 5%;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        header.scrolled {
            background-color: var(--dark);
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .logo i {
            color: var(--primary);
        }

        .search-container {
            position: relative;
            width: 40%;
        }

        .search-container input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .search-container input:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.7);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: var(--dark-3);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .search-result-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--dark-2);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-result-item:hover {
            background-color: var(--dark-2);
        }

        .search-result-item img {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
        }

        .search-result-info h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .search-result-info p {
            font-size: 14px;
            color: var(--gray);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--light);
            font-size: 22px;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            color: var(--primary);
        }

        .user-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
        }

        /* Main Content */
        main {
            padding-top: calc(var(--header-height) + 20px);
            min-height: calc(100vh - var(--header-height) - var(--footer-height));
        }

        .carousel {
            margin: 0 5% 30px;
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            height: 400px;
        }

        .carousel-inner {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease;
        }

        .carousel-item {
            min-width: 100%;
            height: 100%;
            position: relative;
        }

        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 30px;
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }

        .carousel-content h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .carousel-content p {
            max-width: 600px;
            margin-bottom: 20px;
            color: var(--light-2);
        }

        .carousel-controls {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            transform: translateY(-50%);
        }

        .carousel-btn {
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .carousel-btn:hover {
            background: var(--primary);
        }

        .carousel-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: var(--transition);
        }

        .indicator.active {
            background: var(--primary);
            transform: scale(1.2);
        }

        /* Filters Section */
        .filters-section {
            padding: 0 5%;
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--gray);
        }

        .filter-select {
            width: 100%;
            padding: 12px 15px;
            border-radius: var(--radius);
            background-color: var(--dark-3);
            border: 1px solid var(--dark-2);
            color: var(--light);
            font-size: 16px;
            cursor: pointer;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            background-color: var(--dark-3);
            border: none;
            color: var(--light);
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-btn.active, .view-btn:hover {
            background-color: var(--primary);
        }

        /* Content Grid */
        .content-container {
            padding: 0 5% 50px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }

        .content-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            display: none;
        }

        .content-card {
            background-color: var(--dark-2);
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            cursor: pointer;
        }

        .content-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow);
        }

        .content-card.grid {
            aspect-ratio: 2/3;
        }

        .content-card.list {
            display: flex;
            height: 150px;
        }

        .content-card.list .card-img {
            width: 100px;
            height: 100%;
        }

        .card-img {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .content-card.grid .card-img {
            height: 85%;
        }

        .card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
            opacity: 0; /* Start with opacity 0 for lazy loading */
            transition: opacity 0.3s ease;
        }

        .card-img img.loaded {
            opacity: 1;
        }

        .card-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .card-info {
            padding: 15px;
        }

        .content-card.grid .card-info {
            height: 15%;
        }

        .content-card.list .card-info {
            flex: 1;
            padding: 15px 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            gap: 10px;
            font-size: 14px;
            color: var(--gray);
        }

        .card-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-meta i {
            color: var(--primary);
        }

        /* Viewer Page */
        .viewer-page {
            display: none;
            padding: 0 5% 50px;
        }

        .player-container {
            position: sticky;
            top: var(--header-height);
            z-index: 99;
            background-color: var(--dark);
            margin-bottom: 30px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .plyr {
            border-radius: var(--radius);
            overflow: hidden;
        }

        .viewer-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        .content-details {
            background-color: var(--dark-2);
            border-radius: var(--radius);
            padding: 25px;
            position: relative;
        }

        .close-viewer {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--light);
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
        }
        
        /* Back button for mobile */
        .viewer-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--light);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
        }

        .content-title {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .content-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: var(--gray);
        }

        .content-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .content-description {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .selector-group {
            margin-bottom: 25px;
        }

        .selector-group h3 {
            margin-bottom: 15px;
        }

        .selector-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .server-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .server-btn {
            background-color: var(--dark-3);
            border: none;
            color: var(--light);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .server-btn:hover, .server-btn.active {
            background-color: var(--primary);
        }

        .episode-selector {
            width: 100%;
            padding: 10px 15px;
            border-radius: var(--radius);
            background-color: var(--dark-3);
            border: 1px solid var(--dark-2);
            color: var(--light);
            font-size: 16px;
            cursor: pointer;
        }

        .related-title {
            margin: 30px 0 20px;
            font-size: 22px;
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .season-selector {
            background-color: var(--dark-2);
            border-radius: var(--radius);
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .season-selector h3 {
            margin-bottom: 20px;
        }

        .seasons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .season-card {
            background-color: var(--dark-3);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }

        .season-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .season-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .season-info {
            padding: 12px;
            text-align: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--dark-2);
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--dark-3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--light);
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .modal-body {
            padding: 20px;
        }

        /* Footer */
        footer {
            background-color: var(--dark-2);
            padding: 30px 5%;
            border-top: 1px solid var(--dark-3);
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .footer-logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .footer-about p {
            color: var(--gray);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .footer-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--light);
        }

        .footer-links {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .footer-links a {
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-links a:hover {
            color: var(--primary);
        }

        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .social-links a {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--dark-3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light);
            transition: var(--transition);
        }

        .social-links a:hover {
            background-color: var(--primary);
            transform: translateY(-5px);
        }

        .adsense-banner {
            height: 120px;
            background: linear-gradient(45deg, #1a2a6c, #b21f1f, #1a2a6c);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            color: white;
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 1px;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid var(--dark-3);
            color: var(--gray);
            font-size: 14px;
        }

        /* Performance Optimizations */
        .load-more-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .load-more-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .load-more-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
        }
        
        .virtual-scroll-container {
            position: relative;
            height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Styles */
        @media (max-width: 1200px) {
            .viewer-content {
                grid-template-columns: 1fr;
            }
            
            .carousel {
                height: 350px;
            }
        }

        @media (max-width: 992px) {
            .carousel {
                height: 300px;
            }
            
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .search-container {
                width: 50%;
            }
        }

        @media (max-width: 768px) {
            .carousel {
                height: 250px;
            }
            
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .search-container {
                width: 60%;
            }
            
            .header-controls {
                gap: 15px;
            }
            
            .carousel-content h2 {
                font-size: 1.8rem;
            }
            
            .carousel-content p {
                font-size: 14px;
            }
            
            /* Mobile search visibility */
            .search-container {
                position: absolute;
                top: 70px;
                left: 0;
                width: 100%;
                padding: 0 20px;
                display: none;
                z-index: 1001; /* Added for mobile visibility */
            }
            
            .search-container.active {
                display: block;
            }
            
            .mobile-search-btn {
                display: block;
            }
            
            .search-results {
                max-height: 200px; /* Adjusted for mobile */
            }
            
            .search-container input {
                background-color: rgba(0,0,0,0.9); /* Better contrast for mobile */
            }
        }

        @media (max-width: 576px) {
            .logo {
                font-size: 22px;
            }
            
            .carousel {
                height: 200px;
                margin-top: 20px;
            }
            
            .carousel-content {
                padding: 15px;
            }
            
            .carousel-content h2 {
                font-size: 1.4rem;
            }
            
            .carousel-content p {
                display: none;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .view-toggle {
                margin-top: 15px;
            }
            
            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 15px;
            }
            
            .mobile-search-btn {
                background: none;
                border: none;
                color: var(--light);
                font-size: 20px;
                cursor: pointer;
            }
            
            /* Mobile viewer adjustments */
            .viewer-back-btn {
                display: block;
            }
            
            .viewer-content {
                gap: 20px;
            }
            
            .content-details {
                padding: 20px 15px;
            }
        }

        .mobile-search-btn {
            display: none;
        }
        
        .viewer-back-btn {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <a href="#" class="logo">
            <i class="fas fa-film"></i>
            <span>CineCraze</span>
        </a>
        
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search movies, TV shows...">
            <div class="search-results" id="search-results"></div>
        </div>
        
        <div class="header-controls">
            <button class="mobile-search-btn" id="mobile-search-btn">
                <i class="fas fa-search"></i>
            </button>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
            <div class="user-profile">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main>
        <!-- Carousel -->
        <div class="carousel">
            <div class="carousel-inner" id="carousel-inner">
                <!-- Carousel items will be dynamically added here -->
            </div>
            <div class="carousel-controls">
                <button class="carousel-btn" id="carousel-prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-btn" id="carousel-next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="carousel-indicators" id="carousel-indicators">
                <!-- Indicators will be dynamically added here -->
            </div>
        </div>
        
        <!-- Filters Section -->
        <div class="filters-section">
            <div class="section-header">
                <h2 class="section-title">Browse Content</h2>
                <div class="view-toggle">
                    <button class="view-btn active" id="grid-view">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="view-btn" id="list-view">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
            
            <div class="filters-row">
                <div class="filter-group">
                    <label for="category-filter">Category</label>
                    <select id="category-filter" class="filter-select">
                        <option value="all">All Categories</option>
                        <option value="movies">Movies</option>
                        <option value="series">TV Series</option>
                        <option value="live">Live TV</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="genre-filter">Genre</label>
                    <select id="genre-filter" class="filter-select">
                        <option value="all">All Genres</option>
                        <!-- Options will be dynamically added -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="country-filter">Country</label>
                    <select id="country-filter" class="filter-select">
                        <option value="all">All Countries</option>
                        <!-- Options will be dynamically added -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sort-filter">Sort By</label>
                    <select id="sort-filter" class="filter-select">
                        <option value="newest">Newest First</option>
                        <option value="popular">Most Popular</option>
                        <option value="rating">Highest Rated</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Content Grid/List -->
        <div class="content-container">
            <div class="content-grid" id="content-grid">
                <!-- Content cards will be dynamically added here -->
            </div>
            
            <div class="content-list" id="content-list">
                <!-- List view will be dynamically added here -->
            </div>
            
            <!-- Load More Button Container -->
            <div class="load-more-container" id="load-more-container">
                <button class="load-more-btn" id="load-more-btn">Load More</button>
            </div>
            
            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loading-spinner"></div>
        </div>
        
        <!-- Viewer Page -->
        <div class="viewer-page" id="viewer-page">
            <div class="player-container">
                <video id="player" playsinline controls>
                    <!-- Source will be set dynamically -->
                </video>
            </div>
            
            <div class="viewer-content">
                <div class="content-main">
                    <div class="content-details">
                        <!-- Back button for mobile and backup -->
                        <button class="viewer-back-btn" id="viewer-back-btn">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        
                        <button class="close-viewer" id="close-viewer">
                            <i class="fas fa-times"></i>
                        </button>
                        <h1 class="content-title" id="viewer-title">Movie Title</h1>
                        <div class="content-meta">
                            <span id="viewer-rating"><i class="fas fa-star"></i> N/A</span>
                            <span id="viewer-duration"><i class="fas fa-clock"></i> N/A</span>
                            <span id="viewer-year"><i class="fas fa-calendar"></i> N/A</span>
                            <span id="viewer-country"><i class="fas fa-globe"></i> N/A</span>
                        </div>
                        <p class="content-description" id="viewer-description">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                        </p>
                        
                        <div class="selector-group" id="server-selector">
                            <h3>Select Server</h3>
                            <div class="server-buttons" id="server-buttons">
                                <!-- Server buttons will be dynamically added -->
                            </div>
                        </div>
                        
                        <div class="selector-group" id="episode-selector-container" style="display: none;">
                            <h3>Select Episode</h3>
                            <select class="episode-selector" id="episode-selector">
                                <!-- Episode options will be dynamically added -->
                            </select>
                        </div>
                        
                        <div class="season-selector" id="season-selector">
                            <h3>Seasons</h3>
                            <div class="seasons-grid" id="seasons-grid">
                                <!-- Season cards will be dynamically added -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="content-sidebar">
                    <h2 class="related-title">You May Also Like</h2>
                    <div class="related-grid" id="related-grid">
                        <!-- Related content will be dynamically added -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-about">
                <div class="footer-logo">CineCraze</div>
                <p>Your ultimate destination for unlimited movies, TV shows, and live television. Stream anytime, anywhere on all your devices.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-tiktok"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            
            <div class="footer-links-group">
                <h3 class="footer-title">Quick Links</h3>
                <div class="footer-links">
                    <a href="#">Home</a>
                    <a href="#">Movies</a>
                    <a href="#">TV Series</a>
                    <a href="#">Live TV</a>
                    <a href="#">New Releases</a>
                </div>
            </div>
            
            <div class="footer-links-group">
                <h3 class="footer-title">Support</h3>
                <div class="footer-links">
                    <a href="#">Contact Us</a>
                    <a href="#">FAQ</a>
                    <a href="#">Help Center</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Privacy Policy</a>
                </div>
            </div>
            
            <div class="footer-links-group">
                <h3 class="footer-title">Contact</h3>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-envelope"></i> support@cinecraze.com</a>
                    <a href="#"><i class="fas fa-phone"></i> +1 (800) 123-4567</a>
                    <a href="#"><i class="fas fa-map-marker-alt"></i> Hollywood, CA 90028, USA</a>
                </div>
            </div>
        </div>
        
        <div class="adsense-banner">
            ADVERTISEMENT
        </div>
        
        <div class="footer-bottom">
            &copy; 2023 CineCraze. All Rights Reserved.
        </div>
    </footer>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        // Configuration
        const ITEMS_PER_PAGE = 20;
        const LAZY_LOAD_THRESHOLD = 100; // px from bottom to trigger load
        
        // SAMPLE DATA - Replace this with your actual data source
        let cineData = null;
        let cachedContent = [];
        let currentPage = 1;
        let totalPages = 0;
        let isFetching = false;
        let isInitialLoad = true; // Flag for initial content shuffle
        
        // DOM Elements
        const elements = {
            header: document.querySelector('header'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            themeToggle: document.getElementById('theme-toggle'),
            gridViewBtn: document.getElementById('grid-view'),
            listViewBtn: document.getElementById('list-view'),
            contentGrid: document.getElementById('content-grid'),
            contentList: document.getElementById('content-list'),
            categoryFilter: document.getElementById('category-filter'),
            genreFilter: document.getElementById('genre-filter'),
            countryFilter: document.getElementById('country-filter'),
            sortFilter: document.getElementById('sort-filter'), // Added sort filter element
            viewerPage: document.getElementById('viewer-page'),
            viewerTitle: document.getElementById('viewer-title'),
            viewerDescription: document.getElementById('viewer-description'),
            viewerRating: document.getElementById('viewer-rating'),
            viewerDuration: document.getElementById('viewer-duration'),
            viewerYear: document.getElementById('viewer-year'),
            viewerCountry: document.getElementById('viewer-country'),
            serverButtons: document.getElementById('server-buttons'),
            episodeSelectorContainer: document.getElementById('episode-selector-container'),
            episodeSelector: document.getElementById('episode-selector'),
            seasonSelector: document.getElementById('season-selector'),
            seasonsGrid: document.getElementById('seasons-grid'),
            relatedGrid: document.getElementById('related-grid'),
            player: document.getElementById('player'),
            carouselInner: document.getElementById('carousel-inner'),
            carouselPrev: document.getElementById('carousel-prev'),
            carouselNext: document.getElementById('carousel-next'),
            carouselIndicators: document.getElementById('carousel-indicators'),
            mobileSearchBtn: document.getElementById('mobile-search-btn'),
            searchContainer: document.querySelector('.search-container'),
            closeViewerBtn: document.getElementById('close-viewer'),
            viewerBackBtn: document.getElementById('viewer-back-btn'),
            loadMoreBtn: document.getElementById('load-more-btn'),
            loadMoreContainer: document.getElementById('load-more-container'),
            loadingSpinner: document.getElementById('loading-spinner')
        };
        
        // State
        let currentView = 'grid';
        let currentContent = [];
        let currentCarouselIndex = 0;
        let playerInstance = null;
        let currentEpisode = null;
        let currentSeason = null;
        let currentSeries = null;
        
        // Function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Sort content based on criteria
        function sortContent(content, criteria) {
            return [...content].sort((a, b) => {
                switch(criteria) {
                    case 'newest':
                        return (parseInt(b.Year) || 0) - (parseInt(a.Year) || 0);
                    case 'popular':
                        // Fallback to rating if popularity isn't available
                        return (parseFloat(b.Rating) || 0) - (parseFloat(a.Rating) || 0);
                    case 'rating':
                        return (parseFloat(b.Rating) || 0) - (parseFloat(a.Rating) || 0);
                    default:
                        return 0;
                }
            });
        }
        
        // Initialize the app
        function init() {
            fetchData().then(() => {
                renderCarousel();
                renderContentFilters();
                renderContent();
                setupEventListeners();
                updateCarousel();
                setupLazyLoading();
            });
        }
        
        // Fetch data from API or local file
        async function fetchData() {
            try {
                elements.loadingSpinner.style.display = 'block';
                
                const response = await fetch("https://movie-fcs.fwh.is/cinecraze/pagsure.json");
                if (!response.ok) throw new Error("Online source failed");
                
                cineData = await response.json();
                console.log("✅ Loaded from ONLINE source");
                
                // Fix data inconsistencies
                fixDataInconsistencies();
            } catch (err) {
                console.warn("⚠️ Online source failed, trying offline...", err);
                
                try {
                    const offlineResponse = await fetch("./pagsure.json");
                    if (!offlineResponse.ok) throw new Error("Offline file not found");
                    
                    cineData = await offlineResponse.json();
                    console.log("✅ Loaded from OFFLINE file");
                    
                    // Fix data inconsistencies
                    fixDataInconsistencies();
                } catch (err2) {
                    console.error("❌ Both online and offline data failed to load.", err2);
                    alert("Data loading failed. Please check your internet or local file.");
                }
            } finally {
                elements.loadingSpinner.style.display = 'none';
            }
        }
        
        // Fix data inconsistencies
        function fixDataInconsistencies() {
            if (!cineData || !cineData.Categories) return;
            
            // Fix Naruto Kid inconsistencies
            cineData.Categories.forEach(category => {
                category.Entries = category.Entries.map(entry => {
                    // Fix trailing dash in title
                    if (entry.Title && entry.Title.endsWith(' -')) {
                        entry.Title = entry.Title.slice(0, -1).trim();
                    }
                    
                    // Fix Naruto Kid specific issues
                    if (entry.Title === "Naruto Kid") {
                        // Fix rating inconsistency
                        if (!entry.Rating) entry.Rating = "8.5";
                        
                        // Fix country inconsistency
                        if (!entry.Country) entry.Country = "Japan";
                        
                        // Fix description consistency
                        entry.Description = "An anime series in Tagalog Dub";
                        
                        // Fix content type
                        entry.type = "series";
                        
                        // Add season data if missing
                        if (!entry.Seasons) {
                            entry.Seasons = [{
                                Season: 1,
                                SeasonPoster: entry.Poster,
                                Episodes: [
                                    {
                                        Episode: 1,
                                        Title: "The Beginning",
                                        Description: "The start of Naruto's journey",
                                        Servers: [
                                            { name: "480p", url: "https://example.com/naruto-ep1-480p" }
                                        ]
                                    }
                                ]
                            }];
                        }
                    }
                    
                    // Fix other inconsistencies as needed
                    if (entry.Title === "Boruto: Naruto Next Generations") {
                        entry.Description = "The next generation of ninja adventures in the Hidden Leaf Village under the leadership of the Seventh Hokage Naruto Uzumaki.";
                    }
                    
                    return entry;
                });
            });
        }
        
        // Render carousel
        function renderCarousel() {
            if (!cineData || !cineData.Categories) return;
            
            const featuredContent = [];
            
            // Add movies
            cineData.Categories[0].Entries.slice(0, 3).forEach(movie => {
                featuredContent.push({
                    type: 'movie',
                    title: movie.Title,
                    description: movie.Description,
                    image: movie.Poster
                });
            });
            
            // Add TV series
            cineData.Categories[1].Entries.slice(0, 1).forEach(series => {
                featuredContent.push({
                    type: 'series',
                    title: series.Title,
                    description: series.Description || `Popular ${series.SubCategory} series`,
                    image: series.Poster
                });
            });
            
            // Add live TV
            cineData.Categories[2].Entries.slice(0, 1).forEach(live => {
                featuredContent.push({
                    type: 'live',
                    title: live.Title,
                    description: live.Description,
                    image: live.Poster
                });
            });
            
            // Shuffle the featured content
            shuffleArray(featuredContent);
            
            // Render carousel items
            elements.carouselInner.innerHTML = '';
            elements.carouselIndicators.innerHTML = '';
            
            featuredContent.forEach((item, index) => {
                // Carousel item
                const carouselItem = document.createElement('div');
                carouselItem.className = 'carousel-item';
                carouselItem.innerHTML = `
                    <img src="${item.image}" alt="${item.title}">
                    <div class="carousel-content">
                        <h2>${item.title}</h2>
                        <p>${item.description}</p>
                    </div>
                `;
                elements.carouselInner.appendChild(carouselItem);
                
                // Indicator
                const indicator = document.createElement('div');
                indicator.className = 'indicator';
                indicator.dataset.index = index;
                if (index === 0) indicator.classList.add('active');
                elements.carouselIndicators.appendChild(indicator);
                
                // Add click event to indicator
                indicator.addEventListener('click', () => {
                    currentCarouselIndex = index;
                    updateCarousel();
                });
                
                // Make carousel item clickable
                carouselItem.addEventListener('click', () => {
                    // Find the content and open viewer
                    cineData.Categories.forEach(category => {
                        const found = category.Entries.find(entry => entry.Title === item.title);
                        if (found) {
                            openViewer({
                                ...found,
                                type: category.MainCategory.toLowerCase().includes('movie') ? 'movie' : 
                                    category.MainCategory.toLowerCase().includes('series') ? 'series' : 'live'
                            });
                        }
                    });
                });
            });
        }
        
        // Render content filters
        function renderContentFilters() {
            if (!cineData || !cineData.Categories) return;
            
            // Get unique genres and countries
            const genres = new Set();
            const countries = new Set();
            
            cineData.Categories.forEach(category => {
                category.Entries.forEach(entry => {
                    if (entry.SubCategory) genres.add(entry.SubCategory);
                    if (entry.Country) countries.add(entry.Country);
                });
            });
            
            // Add genres to filter
            elements.genreFilter.innerHTML = '<option value="all">All Genres</option>';
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre.toLowerCase();
                option.textContent = genre;
                elements.genreFilter.appendChild(option);
            });
            
            // Add countries to filter
            elements.countryFilter.innerHTML = '<option value="all">All Countries</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.toLowerCase();
                option.textContent = country;
                elements.countryFilter.appendChild(option);
            });
        }
        
        // Render content based on filters
        function renderContent() {
            if (!cineData || !cineData.Categories) return;
            
            // Reset pagination
            currentPage = 1;
            currentContent = [];
            
            // Get selected category
            const category = elements.categoryFilter.value;
            const genre = elements.genreFilter.value;
            const country = elements.countryFilter.value;
            const sortBy = elements.sortFilter.value;
            
            // Filter content
            cineData.Categories.forEach(cat => {
                if (category === 'all' || cat.MainCategory.toLowerCase().includes(category)) {
                    cat.Entries.forEach(entry => {
                        // Check genre and country filters
                        const genreMatch = genre === 'all' || 
                            (entry.SubCategory && entry.SubCategory.toLowerCase().includes(genre));
                        const countryMatch = country === 'all' || 
                            (entry.Country && entry.Country.toLowerCase().includes(country));
                        
                        if (genreMatch && countryMatch) {
                            currentContent.push({
                                ...entry,
                                type: cat.MainCategory.toLowerCase().includes('movie') ? 'movie' : 
                                    cat.MainCategory.toLowerCase().includes('series') ? 'series' : 'live'
                            });
                        }
                    });
                }
            });
            
            // Shuffle content on initial load
            if (isInitialLoad) {
                currentContent = shuffleArray(currentContent);
                isInitialLoad = false;
            } 
            // Apply sorting if not initial load
            else {
                currentContent = sortContent(currentContent, sortBy);
            }
            
            // Calculate total pages
            totalPages = Math.ceil(currentContent.length / ITEMS_PER_PAGE);
            
            // Cache filtered content
            cachedContent = [...currentContent];
            
            // Render content
            renderCurrentView();
            
            // Show/hide load more button
            updateLoadMoreButton();
        }
        
        // Render the current view (grid or list)
        function renderCurrentView() {
            if (currentView === 'grid') {
                renderGridView();
            } else {
                renderListView();
            }
        }
        
        // Render grid view with pagination
        function renderGridView() {
            elements.contentGrid.innerHTML = '';
            
            // Get items for current page
            const startIndex = 0;
            const endIndex = currentPage * ITEMS_PER_PAGE;
            const itemsToRender = currentContent.slice(startIndex, endIndex);
            
            itemsToRender.forEach(item => {
                const card = createContentCard(item, 'grid');
                elements.contentGrid.appendChild(card);
            });
            
            // Show the grid view
            elements.contentGrid.style.display = 'grid';
            elements.contentList.style.display = 'none';
        }
        
        // Render list view with pagination
        function renderListView() {
            elements.contentList.innerHTML = '';
            
            // Get items for current page
            const startIndex = 0;
            const endIndex = currentPage * ITEMS_PER_PAGE;
            const itemsToRender = currentContent.slice(startIndex, endIndex);
            
            itemsToRender.forEach(item => {
                const card = createContentCard(item, 'list');
                elements.contentList.appendChild(card);
            });
            
            // Show the list view
            elements.contentGrid.style.display = 'none';
            elements.contentList.style.display = 'flex';
        }
        
        // Create a content card
        function createContentCard(item, viewType) {
            const card = document.createElement('div');
            card.className = `content-card ${viewType}`;
            card.dataset.id = item.Title.replace(/\s+/g, '-').toLowerCase();
            card.dataset.type = item.type;
            
            let badge = '';
            if (item.type === 'live') {
                badge = '<div class="card-badge">LIVE</div>';
            }
            
            card.innerHTML = `
                <div class="card-img">
                    <img data-src="${item.Thumbnail || item.Poster}" alt="${item.Title}" class="lazy-image">
                    ${badge}
                </div>
                <div class="card-info">
                    <h3 class="card-title">${item.Title}</h3>
                    <div class="card-meta">
                        <span><i class="fas fa-star"></i> ${item.Rating || 'N/A'}</span>
                        <span><i class="fas fa-clock"></i> ${item.Duration || 'N/A'}</span>
                        ${viewType === 'list' ? `<span><i class="fas fa-globe"></i> ${item.Country || 'N/A'}</span>` : ''}
                    </div>
                    ${viewType === 'list' ? `<p class="card-description">${item.Description || ''}</p>` : ''}
                </div>
            `;
            
            card.addEventListener('click', () => openViewer(item));
            return card;
        }
        
        // Load more content
        function loadMoreContent() {
            if (isFetching) return;
            
            isFetching = true;
            elements.loadingSpinner.style.display = 'block';
            
            setTimeout(() => {
                currentPage++;
                
                if (currentView === 'grid') {
                    renderGridView();
                } else {
                    renderListView();
                }
                
                updateLoadMoreButton();
                setupLazyLoading();
                
                isFetching = false;
                elements.loadingSpinner.style.display = 'none';
            }, 300); // Simulate network delay
        }
        
        // Update load more button visibility
        function updateLoadMoreButton() {
            if (currentPage < totalPages) {
                elements.loadMoreContainer.style.display = 'flex';
            } else {
                elements.loadMoreContainer.style.display = 'none';
            }
        }
        
        // Setup lazy loading for images
        function setupLazyLoading() {
            const lazyImages = document.querySelectorAll('.lazy-image');
            
            const lazyLoad = () => {
                lazyImages.forEach(img => {
                    if (img.classList.contains('loaded')) return;
                    
                    const rect = img.getBoundingClientRect();
                    if (rect.top < window.innerHeight + LAZY_LOAD_THRESHOLD) {
                        img.src = img.dataset.src;
                        img.onload = () => {
                            img.classList.add('loaded');
                        };
                    }
                });
            };
            
            // Initial load
            lazyLoad();
            
            // Listen to scroll and resize events
            window.addEventListener('scroll', lazyLoad);
            window.addEventListener('resize', lazyLoad);
        }
        
        // Open viewer for content
        function openViewer(content) {
            // Stop any currently playing content
            if (playerInstance) {
                playerInstance.stop();
            }
            
            // Use History API
            history.pushState({ viewer: true, content }, '', '');
            
            // Hide browse sections
            document.querySelector('.carousel').style.display = 'none';
            document.querySelector('.filters-section').style.display = 'none';
            document.querySelector('.content-container').style.display = 'none';
            
            // Update viewer page content
            elements.viewerTitle.textContent = content.Title;
            elements.viewerDescription.textContent = content.Description || 'No description available.';
            
            // Update meta information
            elements.viewerRating.innerHTML = `<i class="fas fa-star"></i> ${content.Rating || 'N/A'}`;
            elements.viewerDuration.innerHTML = `<i class="fas fa-clock"></i> ${content.Duration || 'N/A'}`;
            elements.viewerYear.innerHTML = `<i class="fas fa-calendar"></i> ${content.Year || 'N/A'}`;
            elements.viewerCountry.innerHTML = `<i class="fas fa-globe"></i> ${content.Country || 'N/A'}`;
            
            // Hide episode selector by default
            elements.episodeSelectorContainer.style.display = 'none';
            elements.episodeSelector.innerHTML = '<option value="">Select Episode</option>';
            
            // Reset season and episode
            currentSeason = null;
            currentEpisode = null;
            currentSeries = content;
            
            // Render server buttons
            if (content.Servers) {
                updateServerButtons(content.Servers);
            }
            
            // Render seasons for TV series
            elements.seasonSelector.style.display = 'none';
            elements.seasonsGrid.innerHTML = '';
            
            if (content.type === 'series' && content.Seasons) {
                elements.seasonSelector.style.display = 'block';
                content.Seasons.forEach(season => {
                    const seasonCard = document.createElement('div');
                    seasonCard.className = 'season-card';
                    seasonCard.innerHTML = `
                        <img src="${season.SeasonPoster || content.Thumbnail}" alt="Season ${season.Season}">
                        <div class="season-info">
                            <h4>Season ${season.Season}</h4>
                        </div>
                    `;
                    seasonCard.addEventListener('click', () => {
                        openSeason(season);
                    });
                    elements.seasonsGrid.appendChild(seasonCard);
                });
            }
            
            // Render related content
            elements.relatedGrid.innerHTML = '';
            // Get 4 random related items (excluding current)
            const relatedContent = cachedContent
                .filter(item => item.Title !== content.Title)
                .sort(() => 0.5 - Math.random())
                .slice(0, 4);
            
            relatedContent.forEach(item => {
                const card = document.createElement('div');
                card.className = 'content-card grid';
                card.innerHTML = `
                    <div class="card-img">
                        <img src="${item.Thumbnail || item.Poster}" alt="${item.Title}">
                    </div>
                    <div class="card-info">
                        <h3 class="card-title">${item.Title}</h3>
                    </div>
                `;
                card.addEventListener('click', () => openViewer(item));
                elements.relatedGrid.appendChild(card);
            });
            
            // Hide main content and show viewer
            elements.viewerPage.style.display = 'block';
            
            // Initialize player if not already done
            if (!playerInstance) {
                playerInstance = new Plyr('#player', {
                    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'fullscreen'],
                    youtube: {
                        noCookie: true,
                        rel: 0,
                        showinfo: 0,
                        iv_load_policy: 3
                    }
                });
                
                // Landscape orientation handling
                playerInstance.on('enterfullscreen', () => {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(error => {
                            console.log('Orientation lock failed: ', error);
                        });
                    }
                });

                playerInstance.on('exitfullscreen', () => {
                    if (screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                });
            }
            
            // Play the first server by default
            if (content.Servers && content.Servers.length > 0) {
                playUrl(content.Servers[0].url);
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        // Play URL with YouTube support
        function playUrl(url) {
            if (!url || !playerInstance) return;
            
            // Check if it's a YouTube URL
            if (isYouTubeUrl(url)) {
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    playerInstance.source = {
                        type: 'video',
                        sources: [{
                            src: videoId,
                            provider: 'youtube'
                        }]
                    };
                    return;
                }
            }
            
            // Regular video URL
            playerInstance.source = {
                type: 'video',
                sources: [{
                    src: url,
                    type: url.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4'
                }]
            };
        }
        
        // Check if URL is YouTube
        function isYouTubeUrl(url) {
            return url.includes('youtube.com') || url.includes('youtu.be');
        }
        
        // Extract YouTube ID
        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        
        // Update server buttons
        function updateServerButtons(servers) {
            elements.serverButtons.innerHTML = '';
            if (servers) {
                servers.forEach((server, index) => {
                    const button = document.createElement('button');
                    button.className = 'server-btn';
                    if (index === 0) button.classList.add('active');
                    button.textContent = server.name;
                    button.addEventListener('click', () => {
                        // Set active server
                        document.querySelectorAll('.server-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        // Change video source
                        playUrl(server.url);
                    });
                    elements.serverButtons.appendChild(button);
                });
            }
        }
        
        // Open season
        function openSeason(season) {
            currentSeason = season;
            
            // Update the episode selector
            elements.episodeSelector.innerHTML = '<option value="">Select Episode</option>';
            season.Episodes.forEach(ep => {
                const option = document.createElement('option');
                option.value = ep.Episode;
                option.textContent = `Episode ${ep.Episode}: ${ep.Title}`;
                elements.episodeSelector.appendChild(option);
            });
            
            // Show the episode selector
            elements.episodeSelectorContainer.style.display = 'block';
            
            // Play the first episode by default
            if (season.Episodes.length > 0) {
                const firstEpisode = season.Episodes[0];
                elements.episodeSelector.value = firstEpisode.Episode;
                playEpisode(firstEpisode);
            }
        }
        
        // Play episode
        function playEpisode(episode) {
            currentEpisode = episode;
            
            // Update the viewer title to include episode info
            elements.viewerTitle.textContent = `${currentSeries.Title} - ${episode.Title}`;
            
            // Update the description to the episode description
            elements.viewerDescription.textContent = episode.Description || currentSeries.Description;
            
            // Update server buttons
            updateServerButtons(episode.Servers);
            
            // Play the first server
            if (episode.Servers && episode.Servers.length > 0) {
                playUrl(episode.Servers[0].url);
            }
        }
        
        // Close viewer
        function closeViewer() {
            // Show browse sections
            document.querySelector('.carousel').style.display = 'block';
            document.querySelector('.filters-section').style.display = 'block';
            document.querySelector('.content-container').style.display = 'block';
            
            // Hide viewer
            elements.viewerPage.style.display = 'none';
            
            if (playerInstance) {
                playerInstance.pause();
                playerInstance.stop();
            }
            
            // Reset player state
            if (playerInstance && playerInstance.source) {
                playerInstance.source = null;
            }
            
            // Reset viewer state
            currentEpisode = null;
            currentSeason = null;
            currentSeries = null;
            
            // Use History API to go back
            history.back();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Theme toggle
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // View toggle
            elements.gridViewBtn.addEventListener('click', () => {
                elements.gridViewBtn.classList.add('active');
                elements.listViewBtn.classList.remove('active');
                currentView = 'grid';
                renderCurrentView();
            });
            
            elements.listViewBtn.addEventListener('click', () => {
                elements.listViewBtn.classList.add('active');
                elements.gridViewBtn.classList.remove('active');
                currentView = 'list';
                renderCurrentView();
            });
            
            // Filter changes
            elements.categoryFilter.addEventListener('change', renderContent);
            elements.genreFilter.addEventListener('change', renderContent);
            elements.countryFilter.addEventListener('change', renderContent);
            elements.sortFilter.addEventListener('change', renderContent); // Added sort change listener
            
            // Search functionality
            elements.searchInput.addEventListener('input', debounce(handleSearch, 300));
            
            // Carousel controls
            elements.carouselPrev.addEventListener('click', () => {
                currentCarouselIndex = (currentCarouselIndex - 1 + elements.carouselInner.children.length) % 
                    elements.carouselInner.children.length;
                updateCarousel();
            });
            
            elements.carouselNext.addEventListener('click', () => {
                currentCarouselIndex = (currentCarouselIndex + 1) % elements.carouselInner.children.length;
                updateCarousel();
            });
            
            // Mobile search button
            elements.mobileSearchBtn.addEventListener('click', () => {
                elements.searchContainer.classList.toggle('active');
                if (elements.searchContainer.classList.contains('active')) {
                    elements.searchInput.focus();
                }
            });
            
            // Close search when clicking outside
            document.addEventListener('click', (event) => {
                if (!elements.searchContainer.contains(event.target) && 
                    !elements.mobileSearchBtn.contains(event.target)) {
                    elements.searchContainer.classList.remove('active');
                }
            });
            
            // Header scroll effect
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    elements.header.classList.add('scrolled');
                } else {
                    elements.header.classList.remove('scrolled');
                }
            });
            
            // Close viewer buttons
            elements.closeViewerBtn.addEventListener('click', closeViewer);
            elements.viewerBackBtn.addEventListener('click', closeViewer);
            
            // Episode selector change
            elements.episodeSelector.addEventListener('change', function() {
                const episodeNum = parseInt(this.value);
                if (!currentSeason) return;
                
                const episode = currentSeason.Episodes.find(ep => ep.Episode === episodeNum);
                if (episode) {
                    playEpisode(episode);
                }
            });
            
            // History API handling
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.viewer) {
                    closeViewer();
                }
            });
            
            // Load more button
            elements.loadMoreBtn.addEventListener('click', loadMoreContent);
            
            // Infinite scroll
            window.addEventListener('scroll', () => {
                if (isFetching) return;
                
                const scrollPosition = window.innerHeight + window.scrollY;
                const documentHeight = document.documentElement.scrollHeight;
                
                if (scrollPosition >= documentHeight - LAZY_LOAD_THRESHOLD) {
                    if (currentPage < totalPages) {
                        loadMoreContent();
                    }
                }
            });
        }
        
        // Toggle theme
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const icon = elements.themeToggle.querySelector('i');
            if (document.body.classList.contains('light-theme')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                document.body.style.backgroundColor = '#f0f0f0';
                document.body.style.color = '#333';
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                document.body.style.backgroundColor = '#141414';
                document.body.style.color = '#f5f5f5';
            }
        }
        
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // Handle search
        function handleSearch() {
            const query = elements.searchInput.value.toLowerCase();
            elements.searchResults.innerHTML = '';
            
            if (query.length < 2) {
                elements.searchResults.style.display = 'none';
                return;
            }
            
            const results = [];
            
            // Search through cached content
            cachedContent.forEach(item => {
                if (item.Title.toLowerCase().includes(query)) {
                    results.push({
                        title: item.Title,
                        type: item.type === 'movie' ? 'Movie' : 
                              item.type === 'series' ? 'TV Series' : 'Live TV',
                        thumbnail: item.Thumbnail || item.Poster,
                        year: item.Year || ''
                    });
                }
            });
            
            if (results.length > 0) {
                results.slice(0, 5).forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `
                        <img src="${result.thumbnail}" alt="${result.title}">
                        <div class="search-result-info">
                            <h4>${result.title}</h4>
                            <p>${result.type} • ${result.year || ''}</p>
                        </div>
                    `;
                    resultItem.addEventListener('click', () => {
                        // Find the content and open viewer
                        const found = cachedContent.find(item => item.Title === result.title);
                        if (found) {
                            openViewer(found);
                        }
                        elements.searchResults.style.display = 'none';
                    });
                    elements.searchResults.appendChild(resultItem);
                });
                elements.searchResults.style.display = 'block';
            } else {
                elements.searchResults.style.display = 'none';
            }
        }
        
        // Update carousel position
        function updateCarousel() {
            elements.carouselInner.style.transform = `translateX(-${currentCarouselIndex * 100}%)`;
            
            // Update indicators
            document.querySelectorAll('.indicator').forEach((indicator, index) => {
                if (index === currentCarouselIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>